<meta name="referrer" content="no-referrer" />

# ä¸šåŠ¡èƒŒæ™¯

ä¸ºä½•è‡ªç ”è·¯ç”±ç»„ä»¶ï¼Ÿ éšç€ä¸šåŠ¡ä½“é‡çš„å¢åŠ ï¼ŒåŸå…ˆçš„åº“è¡¨å­˜å‚¨å·²ç»ä¸èƒ½æ”¯æ’‘æµ·é‡çš„å¹¶å‘è¯·æ±‚ã€‚å› æ­¤ï¼Œå¯èƒ½éœ€è¦è€ƒè™‘åˆ†åº“åˆ†è¡¨ã€‚ æ— è®ºæ˜¯ä¸šåŠ¡ä¹‹åˆå°±è€ƒè™‘åˆ†åº“åˆ†è¡¨ï¼Œè¿˜æ˜¯é¡¹ç›®ä¸­æœŸè¿›è¡Œåˆ†åº“åˆ†è¡¨è¿ç§»ï¼Œè€ƒè™‘è‡ªç ”æ•°æ®åº“è·¯ç”±ç»„ä»¶çš„å‡ºå‘ç‚¹éƒ½æ˜¯ï¼š**
ç°æœ‰çš„æŠ€æœ¯æ–¹æ¡ˆæ— æ³•å®ç°ï¼ˆä¸é€‚åˆã€ä¸æ–¹ä¾¿ï¼‰ä¸ªæ€§åŒ–çš„ä¸šåŠ¡éœ€æ±‚ï¼Œå¹¶ä¸”è‡ªç ”ç»„ä»¶å°è€Œç²¾ï¼Œæ˜“äºè¿­ä»£ç»´æŠ¤ï¼Œåç»­ä¹Ÿå¯åŠ å…¥æ–°çš„åŠŸèƒ½ï¼ˆä¾‹å¦‚äº‹åŠ¡æ”¯æŒï¼‰**
åˆ†åº“ã€åˆ†è¡¨æ˜¯ä¸¤å›äº‹ï¼Œå¯èƒ½åªåˆ†åº“ä¸åˆ†è¡¨ï¼Œå¯èƒ½åˆ†è¡¨ä¸åˆ†åº“ï¼Œä¹Ÿå¯èƒ½åˆ†åº“åˆ†è¡¨

|  | åˆ†åº“åˆ†è¡¨å‰ | åˆ†åº“åˆ†è¡¨å |
| --- | --- | --- |
| å¹¶å‘æ”¯æ’‘æƒ…å†µ | MySQL å•æœºéƒ¨ç½²ï¼Œæ‰›ä¸ä½é«˜å¹¶å‘ | MySQL ä»å•æœºåˆ°å¤šæœºï¼Œèƒ½æ‰¿å—çš„å¹¶å‘å¢åŠ äº†å¤šå€ |
| ç£ç›˜ä½¿ç”¨æƒ…å†µ | MySQL å•æœºç£ç›˜å®¹é‡å‡ ä¹æ’‘æ»¡ | æ‹†åˆ†ä¸ºå¤šä¸ªåº“ï¼Œæ•°æ®åº“æœåŠ¡å™¨ç£ç›˜ä½¿ç”¨ç‡å¤§å¤§é™ä½ |
| SQL æ‰§è¡Œæ€§èƒ½ | å•è¡¨æ•°æ®é‡å¤ªå¤§ï¼ŒSQL è¶Šè·‘è¶Šæ…¢ | å•è¡¨æ•°æ®é‡å‡å°‘ï¼ŒSQL æ‰§è¡Œæ•ˆç‡æ˜æ˜¾æå‡ |

## æ°´å¹³æ‹†åˆ†

![](https://cdn.nlark.com/yuque/0/2023/png/29351684/1683868422759-e51f5bdc-93c6-440f-a222-05c6887ecae5.png#averageHue=%232b2b2b&clientId=u5534c067-c81b-4&from=paste&height=205&id=u47873811&originHeight=315&originWidth=474&originalType=url&ratio=1.100000023841858&rotation=0&showTitle=false&status=done&style=none&taskId=uc57b09b7-9864-4bec-8f35-09d083847c8&title=&width=307.9829406738281)

## å‚ç›´æ‹†åˆ†

![](https://cdn.nlark.com/yuque/0/2023/png/29351684/1683868433798-1501e5cd-a545-4b25-853c-49563b05d3a8.png#averageHue=%233c3c3c&clientId=u5534c067-c81b-4&from=paste&height=211&id=ua3dd6804&originHeight=267&originWidth=320&originalType=url&ratio=1.100000023841858&rotation=0&showTitle=false&status=done&style=none&taskId=u59c074f1-2acd-4c02-96d7-b25044ba11a&title=&width=252.97726440429688)

# æŠ€æœ¯è°ƒç ”

ç°æœ‰çš„åˆ†åº“åˆ†è¡¨ç»„ä»¶ä¸»è¦æœ‰å¦‚ä¸‹ä¸¤ç§ï¼š

## åŸºäºä»£ç†

åœ¨åº”ç”¨å’Œæ•°æ®ä¸­é—´åŠ äº†ä¸€ä¸ªä»£ç†å±‚ã€‚åº”ç”¨ç¨‹åºæ‰€æœ‰çš„æ•°æ®è¯·æ±‚éƒ½äº¤ç»™ä»£ç†å±‚å¤„ç†ï¼Œä»£ç†å±‚è´Ÿè´£åˆ†ç¦»è¯»å†™è¯·æ±‚ï¼Œå°†å®ƒä»¬è·¯ç”±åˆ°å¯¹åº”çš„æ•°æ®åº“ä¸­ã€‚ æä¾›ç±»ä¼¼åŠŸèƒ½çš„ä¸­é—´ä»¶æœ‰ MySQL Routerï¼ˆå®˜æ–¹ï¼‰ã€Atlasï¼ˆåŸºäº MySQL
Proxyï¼‰ã€MaxScaleã€MyCatã€‚

## åŸºäºç»„ä»¶

åŸºäºç»„ä»¶çš„åˆ™ç›´æ¥åŸºäºç‹¬ç«‹çš„ jar åŒ…å°±å¯ä»¥è¿›è¡Œå¼€å‘ï¼Œä¸ç”¨éƒ¨ç½²ï¼Œè¿ç»´æˆæœ¬ä½ï¼Œä¸éœ€è¦ä»£ç†å±‚çš„äºŒæ¬¡è½¬å‘è¯·æ±‚ï¼Œæ€§èƒ½å¾ˆé«˜**ã€‚**æ¯”è¾ƒç»å…¸çš„å°±æ˜¯ Sharding-JDBC
![image.png](https://cdn.nlark.com/yuque/0/2023/png/29351684/1683868079770-2b0d126e-cb44-429b-8e9d-7093b035ec1b.png#averageHue=%23f5eae0&clientId=u5534c067-c81b-4&from=paste&height=306&id=ud054d93c&originHeight=691&originWidth=710&originalType=url&ratio=1.100000023841858&rotation=0&showTitle=false&size=85260&status=done&style=none&taskId=u6876318e-ac82-4ce8-ad7c-71dc104d055&title=&width=313.9829406738281)

# æ–¹æ¡ˆè®¾è®¡

## æŒ‘æˆ˜

1. å®ç°å±‚é¢ï¼šç»„ä»¶éœ€è¦çŸ¥é“**æ•°æ®éœ€è¦ä»å“ªä¸ªå…·ä½“çš„æ•°æ®åº“çš„å­è¡¨ä¸­è·å–ï¼Œå¹¶ä¸”å¯¹ç”¨æˆ·é€æ˜**

- æ•°æ®æºåˆ‡æ¢ï¼šå¦‚ä½•åœ¨ç»„ä»¶ä¸­å®ç°_åŠ¨æ€æ•°æ®æºåˆ‡æ¢_
- è·¯ç”±ç®—æ³•ï¼šå¦‚ä½•å®ç°æ¯”è¾ƒå‡åŒ€çš„_è·¯ç”±æ•£åˆ—ç®—æ³•_
- SQL æ”¹å†™ï¼šå¦‚ä½•æ‹¦æˆªå¹¶ä¿®æ”¹ SQL

2. å¼•å…¥æ•°æ®åˆ†ç‰‡å¸¦æ¥çš„é—®é¢˜ï¼šä¸»è¦è€ƒè™‘**è·¨è¡¨è¿æ¥æŸ¥è¯¢ã€è·¨åº“äº‹åŠ¡é—®é¢˜**

- è·¨è¡¨è¿æ¥æŸ¥è¯¢ï¼šé€šå¸¸ä¸¤ç§æ–¹æ¡ˆï¼šï¼ˆ1ï¼‰è§£å†³è·¨è¡¨æŸ¥è¯¢ï¼›ï¼ˆ2ï¼‰è§„é¿è·¨è¡¨è¿æ¥ï¼Œé‡‡ç”¨ç¬¬ä¸‰æ–¹ä¸­é—´ä»¶æ±‡æ€»æŸ¥è¯¢
- è·¨åº“äº‹åŠ¡ï¼šè¿™å—ä¹Ÿæ˜¯ç—›ç‚¹ï¼Œé€šå¸¸æœ‰ä¸¤ç§åšæ³•ï¼šï¼ˆ1ï¼‰åˆ†å¸ƒå¼äº‹åŠ¡ï¼›ï¼ˆ2ï¼‰è§„é¿åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜ï¼Œé‡‡ç”¨æœ€ç»ˆä¸€è‡´æ€§æ–¹æ¡ˆ

> Tipsï¼š
> å…³äºä»¥ä¸Šè·¨è¡¨è¿æ¥æŸ¥è¯¢ã€è·¨åº“äº‹åŠ¡å…·ä½“è§£å†³æ–¹æ¡ˆï¼Œ_éœ€è¦æ ¹æ®ä¸šåŠ¡åœºæ™¯ã€å¯¹äºæ•°æ®ä¸€è‡´æ€§çš„è¦æ±‚ã€ç»¼åˆæ€§èƒ½ç­‰ç»¼åˆè€ƒè™‘_ã€‚
> ä¾‹å¦‚ï¼š
> - ç§’æ€åœºæ™¯ä¸‹ï¼Œå…³äºåº“å­˜çš„å¤„ç†ï¼Œå°±ä¸å¤ªé€‚åˆä½¿ç”¨ç¹é‡çš„åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œé‡‡ç”¨æœ€ç»ˆä¸€è‡´æ€§æ–¹æ¡ˆï¼ˆMQ+JOBå…œåº•ï¼‰æ¯”è¾ƒåˆé€‚ï¼›åä¹‹ï¼Œå¯¹äºé‡‘èç­‰åœºæ™¯ï¼Œè€ƒè™‘åˆ†å¸ƒå¼äº‹åŠ¡æ¯”è¾ƒåˆé€‚
> - å¯¹äº B ç«¯ç³»ç»Ÿçš„è·¨è¡¨æŸ¥è¯¢åœºæ™¯ï¼Œä¸šåŠ¡è®¿é—®é‡ä¹Ÿä¸ä¼šå¾ˆå¤§ï¼Œè€ƒè™‘é€‚é…è·¨è¡¨è¿æ¥æ–¹æ¡ˆä»£ä»·å°±æ¯”è¾ƒé«˜äº†ï¼Œç›¸åé‡‡ç”¨ ES æ±‡æ€»æŸ¥è¯¢ï¼Œç›¸å¯¹æ¥è¯´å®¹æ˜“æ¥å—ä¸€ç‚¹

## æ¶æ„å›¾

![](https://cdn.nlark.com/yuque/0/2023/jpeg/29351684/1683870147946-a12a9368-e3fd-44ad-996b-b98af53f4474.jpeg)
ä¸»è¦åŒ…æ‹¬ï¼š

- AOP åˆ‡é¢æ‹¦æˆªï¼šæ‹¦æˆªéœ€è¦ä½¿ç”¨DB è·¯ç”±çš„æ–¹æ³•ï¼Œè¿™é‡Œé‡‡ç”¨è‡ªå®šä¹‰æ³¨è§£
- æ•°æ®åº“è¿æ¥æ± é…ç½®ï¼šåˆ†åº“åˆ†è¡¨éœ€è¦æŒ‰éœ€é…ç½®æ•°æ®åº“è¿æ¥æºï¼Œåœ¨è¿™äº›è¿æ¥æ± çš„é›†åˆä¸­è¿›è¡Œ**åŠ¨æ€æ•°æ®æºåˆ‡æ¢**
- `AbstractRoutingDataSource`ï¼šæ˜¯ç”¨äºåŠ¨æ€æ•°æ®æºåˆ‡æ¢çš„ Spring æœåŠ¡ç±»ï¼Œæä¾›äº†æ•°æ®æºåˆ‡æ¢çš„æŠ½è±¡æ–¹æ³• `determineCurrentLookupKey`
- è·¯ç”±å“ˆå¸Œç®—æ³•è®¾è®¡ï¼šåœ¨è·¯ç”±è®¾è®¡æ—¶ï¼Œéœ€è¦æ ¹æ®åˆ†åº“åˆ†è¡¨å­—æ®µè¿›è¡Œè·¯ç”±è®¡ç®—ï¼Œè®©æ•°æ®å‡åŒ€åœ°åˆ†å¸ƒè‡³å„ä¸ªåº“è¡¨ä¹‹ä¸­ã€‚è¿™é‡Œå‚è€ƒ HashMap çš„ æ‰°åŠ¨å‡½æ•°è®¾è®¡
- MyBatis æ‹¦æˆªå™¨ï¼šå®ç° sql åŠ¨æ€æ‹¦æˆªå’Œä¿®æ”¹

## æµç¨‹å›¾

![](https://cdn.nlark.com/yuque/0/2023/jpeg/29351684/1687596062861-f95c89e5-5c97-4cb5-b476-78e9c8d80ded.jpeg)

# æŠ€æœ¯å®ç°

## å·¥ç¨‹ç»“æ„

```
â”œâ”€src
â”‚  â”œâ”€main
â”‚  â”‚  â”œâ”€java
â”‚  â”‚  â”‚  â””â”€io
â”‚  â”‚  â”‚      â””â”€github
â”‚  â”‚  â”‚          â””â”€mokeeqian
â”‚  â”‚  â”‚              â””â”€router
â”‚  â”‚  â”‚                  â”œâ”€annotation
â”‚  â”‚  â”‚                  â”œâ”€aop
â”‚  â”‚  â”‚                  â”œâ”€config
â”‚  â”‚  â”‚                  â”œâ”€context
â”‚  â”‚  â”‚                  â”œâ”€dynamic
â”‚  â”‚  â”‚                  â”œâ”€model
â”‚  â”‚  â”‚                  â”œâ”€strategy
â”‚  â”‚  â”‚                  â”‚  â””â”€impl
â”‚  â”‚  â”‚                  â””â”€util
â”‚  â”‚  â””â”€resources
â”‚  â”‚      â””â”€META-INF
â”‚  â””â”€test
â”‚      â””â”€java
```

## è‡ªå®šä¹‰è·¯ç”±æ³¨è§£

**è·¯ç”±æ³¨è§£**
ä¸ºåˆ‡é¢æä¾›åˆ‡ç‚¹ï¼ŒåŒæ—¶è·å–è¢«æ³¨è§£çš„æ–¹æ³•å…¥å‚å±æ€§ä¸­çš„è·¯ç”±å­—æ®µ

```java

@Documented
@Retention(RetentionPolicy.RUNTIME)
@Target({ElementType.METHOD, ElementType.TYPE})
public @interface DBRouter {
  /**
   * è·¯ç”±å­—æ®µ
   * @return
   */
  String key() default "";
}
```

- @Retentionï¼šå‘Šè¯‰ç¼–è¯‘ç¨‹åºå¦‚ä½•å¤„ç†ï¼Œä¹Ÿå¯ç†è§£ä¸ºæ³¨è§£ç±»çš„ç”Ÿå‘½å‘¨æœŸã€‚
- @Targetï¼šè¯¥æ³¨è§£çš„ä½œç”¨ç‚¹ï¼Œä¸»è¦æœ‰ï¼šTYPEï¼ˆç±»ã€æ¥å£ï¼‰ã€METHODï¼ˆæ–¹æ³•ï¼‰ã€PACKAGEã€FIELDã€PARAMETERç­‰ã€‚è¿™é‡Œæˆ‘ä»¬é€‰æ‹©ä½œç”¨åœ¨æ–¹æ³•ä¸Šã€‚

**è·¯ç”±ç­–ç•¥æ³¨è§£**

```java

@Documented
@Retention(RetentionPolicy.RUNTIME)
@Target({ElementType.TYPE, ElementType.METHOD})
public @interface DBRouterStrategy {
  /**
   * æ˜¯å¦åˆ†è¡¨
   * @return
   */
  boolean splitTable() default false;
}
```

## ğŸ”ƒåŠ¨æ€æ•°æ®æºåˆ‡æ¢

ç»§æ‰¿æŠ½è±¡ç±» `AbstractRoutingDataSource`ï¼Œå®ç°å…¶ `determineCurrentLookupKey` æ–¹æ³•ï¼Œä» DBContextHolderä¸­è·å– DB keyï¼Œç”¨ä»¥å®ç°åŠ¨æ€åˆ‡æ¢æ•°æ®æº

```java
public class DynamicDataSource extends AbstractRoutingDataSource {
  @Override
  protected Object determineCurrentLookupKey() {
    // db01, db02, ...
    return "db" + RouterContext.getDatabaseKey();
  }
}
```

AbstractRoutingDataSourceçš„getConnection() â½…æ³•æ ¹æ®æŸ¥æ‰¾ lookup key é”®å¯¹ä¸åŒâ½¬æ ‡æ•°æ®æºçš„è°ƒâ½¤ï¼Œ é€šå¸¸æ˜¯é€šè¿‡(ä½†ä¸â¼€å®š)æŸäº›çº¿ç¨‹ç»‘å®šçš„äº‹ç‰©ä¸Šä¸‹â½‚æ¥å®ç°
AbstractRoutingDataSourceçš„å¤šæ•°æ®æºåŠ¨æ€ åˆ‡æ¢çš„æ ¸â¼¼é€»è¾‘æ˜¯ï¼šåœ¨ç¨‹åºè¿â¾æ—¶ï¼ŒæŠŠæ•°æ®æºæ•°æ®æºé€šè¿‡AbstractRoutingDataSource åŠ¨æ€ç»‡â¼Šåˆ°ç¨‹åº ä¸­ï¼Œçµæ´»çš„è¿›â¾æ•°æ®æºåˆ‡æ¢
åŸºäºAbstractRoutingDataSourceçš„å¤šæ•°æ®æºåŠ¨æ€åˆ‡æ¢ï¼Œå¯ä»¥å®ç°è¯»å†™åˆ†ç¦»ï¼Œè¿™ä¹ˆåšç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œâ½†æ³• åŠ¨æ€çš„å¢åŠ æ•°æ®æº

## âš™ï¸é…ç½®ã€åŠ è½½ã€åˆ›å»ºæ•°æ®æº

å¯¹äºè¾ƒå¤æ‚çš„æ•°æ®æºé…ç½®ï¼Œä¸€èˆ¬ä½¿ç”¨ `org.springframework.context.EnvironmentAware`æ¥å®ç°ï¼š
**EnvironmentAware#setEnvironmentï¼šè¯»å– yml é…ç½®æ–‡ä»¶ä¸­çš„è‡ªå®šä¹‰åˆ†åº“åˆ†è¡¨é…ç½®**

```java
public void setEnvironment(Environment environment){
        String prefix="mini-db-router.jdbc.datasource.";

        databaseCount=Integer.parseInt(Objects.requireNonNull(environment.getProperty(prefix+"dbCount")));
        tableCount=Integer.parseInt(Objects.requireNonNull(environment.getProperty(prefix+"tbCount")));
        routerKey=environment.getProperty(prefix+"routerKey");

        // åˆ†åº“åˆ—è¡¨ db01,db02
        String dataSources=environment.getProperty(prefix+"list");
        assert dataSources!=null;
        for(String dbInfo:dataSources.split(",")){
        Map<String, Object> dataSourceProps=PropertyUtil.handle(environment,prefix+dbInfo,Map.class);
        dataSourceMap.put(dbInfo,dataSourceProps);
        }

        // é»˜è®¤æ•°æ®æº
        String defaultData=environment.getProperty(prefix+"default");
        defaultDataSourceConfig=PropertyUtil.handle(environment,prefix+defaultData,Map.class);
        }
```

```yaml
router:
  jdbc:
    datasource:
      # ä»è¿™é‡Œå¼€å§‹å°±æ˜¯æ•°æ®æºçš„é…ç½®äº†
      dbCount: 2
      tbCount: 4
      default: db00
      routerKey: uId    # è·¯ç”±å­—æ®µ
      list: db01,db02 # åˆ†åº“
      db00:
        driver-class-name: com.mysql.jdbc.Driver
        url: jdbc:mysql://127.0.0.1:3306/lottery?useUnicode=true
        username: root
        password: xxx
      db01:
        driver-class-name: com.mysql.jdbc.Driver
        url: jdbc:mysql://127.0.0.1:3306/lottery_01?useUnicode=true
        username: root
        password: xxx
      db02:
        driver-class-name: com.mysql.jdbc.Driver
        url: jdbc:mysql://127.0.0.1:3306/lottery_02?useUnicode=true
        username: root
        password: xxx
```

**åˆ›å»ºæ•°æ®æºï¼šDynamicDataSource#setTargetDataSourcesï¼ŒDynamicDataSource#setDefaultTargetDataSource**

```java
    @Bean
public DataSource dataSource(){
        Map<Object, Object> targetDataSources=new HashMap<>();
        for(String dbInfo:dataSourceMap.keySet()){
        Map<String, Object> objMap=dataSourceMap.get(dbInfo);
        targetDataSources.put(dbInfo,new DriverManagerDataSource(
        objMap.get("url").toString(),objMap.get("username").toString(),objMap.get("password").toString())
        );
        }

        // è®¾ç½®æ•°æ®æº
        DynamicDataSource dynamicDataSource=new DynamicDataSource();
        dynamicDataSource.setTargetDataSources(targetDataSources);
        dynamicDataSource.setDefaultTargetDataSource(
        new DriverManagerDataSource(
        defaultDataSourceConfig.get("url").toString(),
        defaultDataSourceConfig.get("username").toString(),
        defaultDataSourceConfig.get("password").toString()
        )
        );
        return dynamicDataSource;
        }
```

## ThreadLocal ä¿å­˜è·¯ç”±ç»“æœ

ä½¿ç”¨ ThreadLocal ä¿å­˜åˆ†åº“ã€åˆ†è¡¨çš„è·¯ç”±ç»“æœï¼Œå€Ÿé‰´ SecurityContextHolder

```java
public class RouterContext {
  private static final ThreadLocal<String> DATABASE_KEY = new ThreadLocal<>();
  private static final ThreadLocal<String> TABLE_KEY = new ThreadLocal<>();

  public static String getDatabaseKey() {
    return DATABASE_KEY.get();
  }

  public static void setDatabaseKey(String databaseKey) {
    DATABASE_KEY.set(databaseKey);
  }

  public static String getTableKey() {
    return TABLE_KEY.get();
  }

  public static void setTableKey(String tableKey) {
    TABLE_KEY.set(tableKey);
  }

  public static void clearDatabaseKey() {
    DATABASE_KEY.remove();
  }

  public static void clearTableKey() {
    TABLE_KEY.remove();
  }
}
```

## å…·ä½“è·¯ç”±ç­–ç•¥

è¿™é‡Œé‡‡ç”¨æ¥å£ `IDBRouterStrategy` ï¼Œåç»­å¯ä»¥å®ç°è¯¥æ¥å£ï¼Œè¿›è¡Œä¸ªæ€§åŒ–çš„è·¯ç”±ç­–ç•¥é…ç½®
![image.png](https://cdn.nlark.com/yuque/0/2023/png/29351684/1683910558463-7c96f9a7-ef81-4557-8c1e-656846b3bf7d.png#averageHue=%23ad8a49&clientId=u5534c067-c81b-4&from=paste&height=244&id=udf6dfd35&originHeight=640&originWidth=640&originalType=binary&ratio=1.100000023841858&rotation=0&showTitle=false&size=25340&status=done&style=none&taskId=u00c946c1-19d1-42ac-8c68-5e0f049c3e1&title=&width=243.99429321289062)
**åŸºäºHashMap æ‰°åŠ¨å‡½æ•°æ€æƒ³å®ç°è·¯ç”±åˆ†å‘**

```java
@Override
public void doRouter(String databaseKeyFieldValue){
        // æ€»çš„åº“è¡¨æ•°ç›®
        int size=routerConfig.getDatabaseCount()*routerConfig.getTableCount();

        // æ‰°åŠ¨å‡½æ•°ï¼›åœ¨ JDK çš„ HashMap ä¸­ï¼Œå¯¹äºä¸€ä¸ªå…ƒç´ çš„å­˜æ”¾ï¼Œéœ€è¦è¿›è¡Œå“ˆå¸Œæ•£åˆ—ã€‚è€Œä¸ºäº†è®©æ•£åˆ—æ›´åŠ å‡åŒ€ï¼Œæ‰€ä»¥æ·»åŠ äº†æ‰°åŠ¨å‡½æ•°ã€‚
        int idx=(size-1)&(databaseKeyFieldValue.hashCode()^(databaseKeyFieldValue.hashCode()>>>16));

        // åº“è¡¨ç´¢å¼•ï¼›ç›¸å½“äºæ˜¯æŠŠä¸€ä¸ªé•¿æ¡çš„æ¡¶ï¼Œåˆ‡å‰²æˆæ®µï¼Œå¯¹åº”åˆ†åº“åˆ†è¡¨ä¸­çš„åº“ç¼–å·å’Œè¡¨ç¼–å·
        int dbIdx=idx/routerConfig.getTableCount()+1;
        int tbIdx=idx-routerConfig.getTableCount()*(dbIdx-1);

        // è®¾ç½®è·¯ç”±åˆ° context
        RouterContext.setDatabaseKey(String.format("%02d",dbIdx));
        RouterContext.setTableKey(String.format("%03d",tbIdx));
        }
```

## âœ…åŠ¨æ€ SQL ä¿®æ”¹

åŸºäºä»¥ä¸Šï¼Œåˆ†åº“åŠŸèƒ½å·²ç»å®ç°ï¼Œä½†æ˜¯ï¼Œå¦‚ä½•åˆ†è¡¨ï¼Ÿå³å°†**é€»è¾‘ SQL** è½¬åŒ–ä¸º **ç‰©ç† SQLï¼Œ**ä¾‹å¦‚ï¼š é€»è¾‘SQLï¼š`SELECT * FROM tb_user WHERE id = 123;`
ç‰©ç†SQLï¼š`SELECT * FROM tb_user_01 WHERE id = 123;`
**ä¸€ç§æ€è·¯æ˜¯ï¼šä½¿ç”¨ MyBatis çš„ Interceptor è¿›è¡Œ SQL æ‹¦æˆªï¼Œç„¶ååŠ¨æ€ä¿®æ”¹ SQL**
[mybatisï¼šè‡ªå®šä¹‰å®ç°æ‹¦æˆªå™¨æ’ä»¶Interceptor](https://zhuanlan.zhihu.com/p/286476884)

- **@Interceptsæ³¨è§£**ï¼šæ‹¦æˆªå™¨ å¯ä»¥è¢«æ‹¦æˆªçš„å››ç§ç±»å‹ï¼š
  - Executorï¼šæ‹¦æˆªæ‰§è¡Œå™¨çš„æ–¹æ³•
  - ParameterHandlerï¼šæ‹¦æˆªå‚æ•°çš„å¤„ç†
  - ResultHandlerï¼šæ‹¦æˆªç»“æœé›†çš„å¤„ç†
  - _StatementHandlerï¼šæ‹¦æˆªSqlè¯­æ³•æ„å»ºçš„å¤„ç†_
- @Signatureæ³¨è§£ï¼šæ‹¦æˆªç‚¹ï¼ŒæŒ‡å®šæ‹¦æˆªå“ªä¸ªå¯¹è±¡é‡Œé¢çš„å“ªä¸ªæ–¹æ³• å…¶å‚æ•°å¦‚ä¸‹ï¼š
  - typeï¼šè¦è¢«æ‹¦æˆªçš„ç±»å‹ï¼ˆä¸Šè¿°å››ç§ä¹‹ä¸€ï¼‰
  - methodï¼šåœ¨ç±»å‹åŸºç¡€ä¸Šï¼ŒæŒ‡å®šè¢«æ‹¦æˆªçš„æ–¹æ³•
  - argsï¼šåœ¨æ–¹æ³•åŸºç¡€ä¸Šï¼ŒæŒ‡å®šæ–¹æ³•å…¥å‚å‚æ•°ï¼ˆJavaé‡Œå¯èƒ½å­˜åœ¨é‡è½½ï¼Œæ•…è¦æ³¨æ„å‚æ•°é¡ºåºå’Œç±»å‹ï¼‰
- ç±»å‹&æ–¹æ³•ä¸€è§ˆ

  | æ‹¦æˆªç±»å‹ | æ‹¦æˆªæ–¹æ³• |
    | --- | --- |
  | Executor | updateã€queryã€flushStatementsã€commitã€rollbackã€getTransactionã€closeã€isClosed |
  | ParameterHandler | getParameterObjectã€setParameters |
  | ResultHandler | handleResultSetsã€handleOutputParameters |
  | StatementHandler | prepareã€parameterizeã€batchã€updateã€query |

StatementHandler çš„å…·ä½“æ–¹æ³•ï¼š

- prepare: â½¤äºåˆ›å»ºâ¼€ä¸ªå…·ä½“çš„ Statement å¯¹è±¡çš„å®ç°ç±»æˆ–è€…æ˜¯ Statement å¯¹è±¡
- parametersize: â½¤äºåˆå§‹åŒ– Statement å¯¹è±¡ä»¥åŠå¯¹sqlçš„å ä½ç¬¦è¿›â¾èµ‹å€¼
- update: â½¤äºé€šçŸ¥ Statement å¯¹è±¡å°† insertã€updateã€delete æ“ä½œæ¨é€åˆ°æ•°æ®åº“
- query: â½¤äºé€šçŸ¥ Statement å¯¹è±¡å°† select æ“ä½œæ¨é€æ•°æ®åº“å¹¶è¿”å›å¯¹åº”çš„æŸ¥è¯¢ç»“æœ

æˆ‘ä»¬ä¸»è¦ä½¿ç”¨ StatementHandler çš„ prepare æ–¹æ³•ï¼Œæ‹¦æˆª sql è¯­å¥

```java
@Intercepts(
        @Signature(type = StatementHandler.class, method = "prepare", args = {Connection.class, Integer.class})
)
```

_è¿™é‡Œçš„ Interceptor#intercept æ–¹æ³•å°±æ˜¯æˆ‘ä»¬è¦å®ç°çš„æ–¹æ³•ï¼Œå…¶ä¸­ï¼Œinvocation å°±æ˜¯è¢«æ‹¦æˆªçš„å¯¹è±¡ï¼ˆStatementHandler#prepareæ–¹æ³•ï¼‰_

```java
/**
 * @author Clinton Begin
 */
public interface Interceptor {
  Object intercept(Invocation invocation) throws Throwable;

  default Object plugin(Object target) {
    return Plugin.wrap(target, this);
  }

  default void setProperties(Properties properties) {
    // NOP
  }
}
```

**å¦‚ä½•è·å– MyBatis ä¸­çš„ SQL è¯­å¥ï¼Ÿ**
åŸºäº `StatementHandler`ï¼Œç„¶å è·å–å…¶ BoundSql

```java
// è·å– StatementHandler
StatementHandler statementHandler=(StatementHandler)invocation.getTarget();
        MetaObject metaObject=MetaObject.forObject(statementHandler,SystemMetaObject.DEFAULT_OBJECT_FACTORY,
        SystemMetaObject.DEFAULT_OBJECT_WRAPPER_FACTORY,new DefaultReflectorFactory());
        MappedStatement mappedStatement=(MappedStatement)metaObject.getValue("delegate.mappedStatement");

// è·å– MyBatis åŸå§‹ SQL
        BoundSql boundSql=statementHandler.getBoundSql();
        String originalSql=boundSql.getSql();
```

**å¦‚ä½•è¯†åˆ« SQL ä¸­çš„è¡¨åç§°ï¼Ÿ**
ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ï¼šfromï¼Œintoï¼Œupdate è¿™ä¸‰ä¸ªå…³é”®å­—ï¼Œå…¶ä¹‹åå°±æ˜¯è¡¨åç§°

```java
private Pattern pattern=Pattern.compile("(from|into|update)[\\s]{1,}(\\w{1,})",Pattern.CASE_INSENSITIVE);
```

**è¯†åˆ«ä¹‹åå¦‚ä½•æ›¿æ¢ï¼Ÿ**
ä½¿ç”¨åå°„ï¼Œç›´æ¥ä¿®æ”¹ `BoundSql#sql` å­—æ®µ

```java
// é€šè¿‡åå°„ä¿®æ”¹ sql è¯­å¥
// getDeclaredFieldï¼šå¯ä»¥è·å–æ‰€æœ‰å·²å£°æ˜å­—æ®µï¼ˆæ— è§†è®¿é—®é™å®šç¬¦ï¼‰; getFieldï¼šåªèƒ½è·å–public å­—æ®µ
Field field=boundSql.getClass().getDeclaredField("sql");
        field.setAccessible(true);
        field.set(boundSql,replacedSql);
        field.setAccessible(false);
```

- ä½¿ç”¨åå°„å¯ä»¥è®¿é—® Java ç±»çš„ç§æœ‰æˆå‘˜ã€ç§æœ‰æ–¹æ³•ã€‚åœ¨æ¡†æ¶å¼€å‘ä¸­ï¼Œç”¨å¤„ååˆ†å¹¿æ³›

## ğŸš«AOP å®ç°è°ƒç”¨æ–¹æ³•æ‹¦æˆª

ç›®å‰ä¸ºæ­¢ï¼Œåº•å±‚é€»è¾‘å·²ç»å…¨éƒ¨å®ç°ï¼Œç°åœ¨åªéœ€è¦ä½¿ç”¨AOPå¯¹è°ƒç”¨æ–¹æ³•è¿›è¡Œæ‹¦æˆªå¤„ç†å³å¯
**å®šä¹‰åˆ‡ç‚¹**
è¿™é‡Œç›´æ¥æ‹¦æˆªå…ˆå‰å®šä¹‰çš„è‡ªå®šä¹‰æ³¨è§£ï¼Œä¹Ÿå¯ä»¥æ˜¯ä½¿ç”¨è¡¨è¾¾å¼åŒ¹é…

```java
/**
 * åˆ‡ç‚¹ï¼Œæ‹¦æˆª @DBRouter
 */
@Pointcut("@annotation(io.github.mokeeqian.router.annotation.DBRouter)")
public void pointCut(){}
```

**å®šä¹‰åˆ‡é¢æ‹¦æˆªå…·ä½“é€»è¾‘**

```java
@Around("pointCut() && @annotation(dbRouter)")
public Object aroundAnnotationDBRouter(ProceedingJoinPoint proceedingJoinPoint,DBRouter dbRouter)throws Throwable{
        // ä» @DBRouter æ³¨è§£ä¸­æ‹¿åˆ°è·¯ç”± Key
        String dbKey=dbRouter.key();
        if(StringUtils.isBlank(dbKey)||StringUtils.isBlank(routerConfig.getRouterKey())){
        throw new RuntimeException("annotation @DBRouter key is null");
        }

        // å¦‚æœ @DBRouter key å±æ€§æœªæŒ‡å®šï¼Œåˆ™é»˜è®¤ä½¿ç”¨ application.yml ä¸­çš„ routerKey
        if(StringUtils.isBlank(dbKey)){
        dbKey=routerConfig.getRouterKey();
        }

        // è·å–è·¯ç”±å­—æ®µçš„å±æ€§å€¼
        String dbKeyFieldValue=parseRouterKeyFieldValue(dbKey,proceedingJoinPoint.getArgs());

        // è·¯ç”±ä¸‹å‘
        routerStrategy.doRouter(dbKeyFieldValue);

        // æ”¾è¡Œ
        try{
        return proceedingJoinPoint.proceed();
        }finally{
        // æ¸…ç©ºè·¯ç”±
        routerStrategy.clear();
        }
        }
```

- å‡ ç§åˆ‡é¢ç¯ç»•é€»è¾‘ï¼š
  - @Beforeï¼šå‰ç½®é€šçŸ¥ï¼Œåœ¨æ–¹æ³•æ‰§è¡Œä¹‹å‰æ‰§è¡Œ
  - @Afterï¼šåç½®é€šçŸ¥ï¼Œåœ¨æ–¹æ³•æ‰§è¡Œä¹‹åæ‰§è¡Œï¼ˆå³ä½¿å‡ºç°å¼‚å¸¸ï¼Œåç½®é€šçŸ¥ä¹Ÿä¼šæ‰§è¡Œï¼‰
  - @Aroundï¼šç¯ç»•é€šçŸ¥ï¼Œå›´ç»•ç€æ–¹æ³•æ‰§è¡Œï¼ˆå¯ä»¥å®ç°å…¶ä»–å››ç§é€šçŸ¥ï¼‰
  - @AfterReturningï¼šè¿”å›é€šçŸ¥ï¼Œåœ¨æ–¹æ³•è¿”å›ç»“æœä¹‹åæ‰§è¡Œ
  - @AfterThrowingï¼šå¼‚å¸¸é€šçŸ¥ï¼Œåœ¨æ–¹æ³•æŠ›å‡ºå¼‚å¸¸ä¹‹å
- AspectJ æ³¨è§£çš„æ‰§è¡Œé¡ºåºï¼š
  _@Around éƒ½ä¼šå‡ºç°ä¸¤æ¬¡ï¼š@Beforeã€@AfterReturningã€@AfterReturningã€@After è¿™å››ä¸ªéƒ½ä¼šåœ¨ä¸¤æ¬¡@Around æ‰§è¡Œä¹‹é—´è¢«æ‰§è¡Œ_
  - æ— å¼‚å¸¸æ—¶ï¼š@Aspectã€@Pointcutã€@Aroundã€@Beforeã€@AfterReturningã€@Afterã€@Around
  - æœ‰å¼‚å¸¸æ—¶ï¼š@Aspectã€@Pointcutã€@Aroundã€@Beforeã€@AfterThrowingã€@Afterã€@Around

## å°è£…èµ·æ­¥ä¾èµ–

æœ€åçš„æœ€åï¼Œå°†é¡¹ç›®å°è£…æˆ SpringBoot èµ·æ­¥ä¾èµ–ï¼Œç¼–å†™é…ç½®ç±»ï¼Œç„¶ååˆ©ç”¨è‡ªåŠ¨è£…é…æœºåˆ¶ã€‚

```java
package io.github.mokeeqian.router.config;

import io.github.mokeeqian.router.aop.RouterAspect;
import io.github.mokeeqian.router.dynamic.DynamicDataSource;
import io.github.mokeeqian.router.dynamic.DynamicMybatisPlugin;
import io.github.mokeeqian.router.model.RouterConfig;
import io.github.mokeeqian.router.strategy.IRouterStrategy;
import io.github.mokeeqian.router.strategy.impl.RouterStrategyHashCode;
import io.github.mokeeqian.router.util.PropertyUtil;
import org.apache.ibatis.plugin.Interceptor;
import org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;
import org.springframework.context.EnvironmentAware;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.core.env.Environment;
import org.springframework.jdbc.datasource.DataSourceTransactionManager;
import org.springframework.jdbc.datasource.DriverManagerDataSource;
import org.springframework.transaction.support.TransactionTemplate;

import javax.sql.DataSource;
import java.util.HashMap;
import java.util.Map;
import java.util.Objects;

/**
 * @description: æ•°æ®æºé…ç½®
 * @authorï¼šmokeeqian
 * @date: 2023/8/27
 * @Copyrightï¼š mokeeqian@gmail.com
 */
@Configuration
public class DataSourceAutoConfig implements EnvironmentAware {

  /**
   * æ•°æ®æº
   * db -> Config
   */
  private Map<String, Map<String, Object>> dataSourceMap = new HashMap<>();

  /**
   * é»˜è®¤æ•°æ®æºé…ç½®
   */
  private Map<String, Object> defaultDataSourceConfig;

  /**
   * database æ•°ç›®
   */
  private int databaseCount;

  /**
   * table æ•°ç›®
   */
  private int tableCount;

  /**
   * è·¯ç”± key
   */
  private String routerKey;

  @Bean
  public RouterConfig routerConfig() {
    return new RouterConfig(this.databaseCount, this.tableCount, this.routerKey);
  }

  @Bean
  public IRouterStrategy routerStrategy(RouterConfig routerConfig) {
    return new RouterStrategyHashCode(routerConfig);
  }

  @Bean
  public Interceptor plugin() {
    return new DynamicMybatisPlugin();
  }

  @Bean(name = "routerAspect")
  @ConditionalOnMissingBean
  public RouterAspect routerAspect(RouterConfig routerConfig, IRouterStrategy routerStrategy) {
    return new RouterAspect(routerConfig, routerStrategy);
  }

  /**
   * è¿™ä¸ªæ•°æ®æºå°±ä¼šè¢« MyBatis SpringBoot Starter ä¸­ SqlSessionFactory sqlSessionFactory(DataSource dataSource) æ³¨å…¥ä½¿ç”¨
   *
   * @return
   */
  @Bean
  public DataSource dataSource() {
    Map<Object, Object> targetDataSources = new HashMap<>();
    for (String dbInfo : dataSourceMap.keySet()) {
      Map<String, Object> objMap = dataSourceMap.get(dbInfo);
      targetDataSources.put(dbInfo, new DriverManagerDataSource(
              objMap.get("url").toString(), objMap.get("username").toString(), objMap.get("password").toString())
      );
    }

    // è®¾ç½®æ•°æ®æº
    DynamicDataSource dynamicDataSource = new DynamicDataSource();
    dynamicDataSource.setTargetDataSources(targetDataSources);
    dynamicDataSource.setDefaultTargetDataSource(
            new DriverManagerDataSource(
                    defaultDataSourceConfig.get("url").toString(),
                    defaultDataSourceConfig.get("username").toString(),
                    defaultDataSourceConfig.get("password").toString()
            )
    );
    return dynamicDataSource;
  }

  @Bean
  public TransactionTemplate transactionTemplate(DataSource dataSource) {
    DataSourceTransactionManager dataSourceTransactionManager = new DataSourceTransactionManager();
    dataSourceTransactionManager.setDataSource(dataSource);

    TransactionTemplate transactionTemplate = new TransactionTemplate();
    transactionTemplate.setTransactionManager(dataSourceTransactionManager);
    transactionTemplate.setPropagationBehaviorName("PROPAGATION_REQUIRED");
    return transactionTemplate;
  }

  /**
   * è¯»å– yml æ•°æ®æºé…ç½®
   *
   * @param environment
   */
  @Override
  public void setEnvironment(Environment environment) {
    String prefix = "mini-db-router.jdbc.datasource.";

    databaseCount = Integer.parseInt(Objects.requireNonNull(environment.getProperty(prefix + "dbCount")));
    tableCount = Integer.parseInt(Objects.requireNonNull(environment.getProperty(prefix + "tbCount")));
    routerKey = environment.getProperty(prefix + "routerKey");

    // åˆ†åº“åˆ—è¡¨ db01,db02
    String dataSources = environment.getProperty(prefix + "list");
    assert dataSources != null;
    for (String dbInfo : dataSources.split(",")) {
      Map<String, Object> dataSourceProps = PropertyUtil.handle(environment, prefix + dbInfo, Map.class);
      dataSourceMap.put(dbInfo, dataSourceProps);
    }

    // é»˜è®¤æ•°æ®æº
    String defaultData = environment.getProperty(prefix + "default");
    defaultDataSourceConfig = PropertyUtil.handle(environment, prefix + defaultData, Map.class);
  }
}
```

éšåï¼Œéœ€è¦ç¼–å†™ `resources/META_INF/spring.factories` æ–‡ä»¶ï¼Œé…ç½®æ•°æ®æºé…ç½®ç±»

```java
org.springframework.boot.autoconfigure.EnableAutoConfiguration=io.github.mokeeqian.router.config.DataSourceAutoConfig
```

æœ€åï¼Œå°†é¡¹ç›®æ‰“åŒ…åˆ° maven ä»“åº“ï¼Œå³å¯ä½¿ç”¨å•¦

# ã€ç•ªå¤–ã€‘åˆ†åº“åˆ†è¡¨å¹³æ»‘è¿‡æ¸¡ï¼Ÿ

åŸºäºåŸå…ˆçš„å•åº“å•è¡¨ï¼Œç°åœ¨å¦‚ä½•åšè¿ç§»ï¼Ÿ

## åœæœºè¿ç§»

æœ€ç®€å•çš„å°±æ˜¯ç›´æ¥åœæœºè¿ç§»ï¼Œåœæ­¢ä¸€åˆ‡å†™å…¥ã€‚ç„¶åå°†æ—§åº“æ•°æ®è¿ç§»è‡³æ–°åº“ã€‚
![](https://cdn.nlark.com/yuque/0/2023/png/29351684/1683868674064-09a7741f-ef77-43c6-ba21-843a140c7384.png#averageHue=%231f1f1f&clientId=u5534c067-c81b-4&from=paste&height=459&id=ub1fd1528&originHeight=636&originWidth=863&originalType=url&ratio=1.100000023841858&rotation=0&showTitle=false&status=done&style=none&taskId=ub8f1269e-c99f-4440-9ba6-e73f329dafe&title=&width=622.1760864257812)

## åŒå†™è¿ç§»

å¦‚æœçº¿ä¸Šä¸šåŠ¡ä¸èƒ½åœæœºæ€ä¹ˆåŠï¼Ÿ

- æˆ‘ä»¬å¯¹è€åº“çš„æ›´æ–°æ“ä½œï¼ˆå¢åˆ æ”¹ï¼‰ï¼ŒåŒæ—¶ä¹Ÿè¦å†™å…¥æ–°åº“ï¼ˆåŒå†™ï¼‰ã€‚å¦‚æœæ“ä½œçš„æ•°æ®ä¸å­˜åœ¨äºæ–°åº“çš„è¯ï¼Œéœ€è¦æ’å…¥åˆ°æ–°åº“ä¸­ã€‚ è¿™æ ·å°±èƒ½ä¿è¯ï¼Œå’±ä»¬æ–°åº“é‡Œçš„æ•°æ®æ˜¯æœ€æ–°çš„ã€‚
- åœ¨è¿ç§»è¿‡ç¨‹ï¼ŒåŒå†™åªä¼šè®©è¢«æ›´æ–°æ“ä½œè¿‡çš„è€åº“ä¸­çš„æ•°æ®åŒæ­¥åˆ°æ–°åº“ï¼Œæˆ‘ä»¬_è¿˜éœ€è¦è‡ªå·±å†™è„šæœ¬å°†è€åº“ä¸­çš„æ•°æ®å’Œæ–°åº“çš„æ•°æ®åšæ¯”å¯¹_ã€‚å¦‚æœæ–°åº“ä¸­æ²¡æœ‰ï¼Œé‚£å’±ä»¬å°±æŠŠæ•°æ®æ’å…¥åˆ°æ–°åº“ã€‚å¦‚æœæ–°åº“æœ‰ï¼Œæ—§åº“æ²¡æœ‰ï¼Œå°±æŠŠæ–°åº“å¯¹åº”çš„æ•°æ®åˆ é™¤ï¼ˆå†—ä½™æ•°æ®æ¸…ç†ï¼‰ã€‚
- é‡å¤ä¸Šä¸€æ­¥çš„æ“ä½œï¼Œç›´åˆ°è€åº“å’Œæ–°åº“çš„æ•°æ®ä¸€è‡´ä¸ºæ­¢

è¿™å—å…¶å®å¯ä»¥å€ŸåŠ© Canal ç­‰ä¸­é—´ä»¶ï¼ˆbinlogä¸»ä»åŒæ­¥åŸç†ï¼‰æ¥å®ç°
![](https://cdn.nlark.com/yuque/0/2023/png/29351684/1683868776523-d993586d-94a9-4285-afac-2e8100de0524.png#averageHue=%231e1e1e&clientId=u5534c067-c81b-4&from=paste&height=490&id=u781d7428&originHeight=661&originWidth=864&originalType=url&ratio=1.100000023841858&rotation=0&showTitle=false&status=done&style=none&taskId=ud24719c9-abcb-4983-a0c0-7f505cce0d5&title=&width=640.1760864257812)

# å‚è€ƒæ–‡ç« 

- [apache shardingsphere](https://shardingsphere.apache.org/)
- [bugstack](https://bugstack.cn/)
